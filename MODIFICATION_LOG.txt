================================================================================
RayTracedicom 剂量计算修复记录
================================================================================
日期: 2024-01-11
问题: 剂量输出为0，且不随能量变化

================================================================================
修复1: rayWeights按层存储结构修复
================================================================================
问题描述:
- rayWeights应该在每个能量层都有不同的值
- CPB卷积时X、Y存储平面坐标，Z存储能量层
- 之前代码在每个能量层循环内重复执行CPB卷积，导致rayWeights对所有层求和

修复内容:
1. 文件: src/core/raytracedicom_wrapper.cu
   - 将CPB卷积和rayWeights映射移到能量层循环外（第82-188行）
   - 在循环外执行一次CPB卷积，生成所有层的CPB权重
   - 为所有层分配rayWeights数组: devRayWeightsAllLayers
   - 在每个能量层循环内，使用 devRayWeightsAllLayers + layerIdx * rayDims.x * rayDims.y 获取当前层的rayWeights

2. 文件: src/algorithms/convolution.cu
   - 修改 mapCPBWeightsToRayWeightsKernel: 添加 layerIdx 参数，只处理指定层
   - 修改 performCPBToRayWeightMapping: 添加 layerIdx 参数
   - 从对所有层求和改为只处理当前层: rayWeights[rayIdx] = cpbWeights[cpbIdx] (不是累加)

3. 文件: include/algorithms/convolution.h
   - 更新 performCPBToRayWeightMapping 函数声明，添加 layerIdx 参数

4. 文件: src/utils/backward_compatibility.cu
   - 更新调用，传递 layerIdx=0 (向后兼容)

================================================================================
修复2: 测试数据中energiesPerU数组大小修复
================================================================================
问题描述:
- energiesPerU应该是nEnergies个元素（能量列表），而不是nEnergySamples个元素

修复内容:
1. 文件: src/tests/wrapper_integration_test.cu
   - 修改 createTestEnergyData():
     * energiesPerU.resize(energy.nEnergies) 而不是 energy.nEnergySamples
     * 设置 energiesPerU[0]=120.0f, [1]=140.0f, [2]=160.0f (匹配测试beam能量)
   - 改进CIDD矩阵生成: 使用高斯分布而不是固定值1.0f

================================================================================
修复3: volConst, volLin, volSq计算修复
================================================================================
问题描述:
- volConst, volLin, volSq都被设置为0，导致stepVol(stepNo)返回0
- mass = density * stepVol(stepNo) = 0，导致剂量计算被跳过

修复内容:
1. 文件: src/core/raytracedicom_wrapper.cu (第376-389行)
   - 添加volConst, volLin, volSq的正确计算，基于RayTracedicom公式:
     * volConst = deltaXYZ * (1.0f - cornerZ/distX - cornerZ/distY + 
                              (cornerZ*cornerZ + deltaZ*deltaZ/12.0f)/(distX*distY))
     * volLin = deltaXYZ * deltaZ * (-1.0f/distX - 1.0f/distY + 2.0f*cornerZ/(distX*distY))
     * volSq = deltaXYZ * deltaZ * deltaZ / (distX * distY)
   - 其中 deltaXYZ = abs(deltaX * deltaY * deltaZ)

================================================================================
修复4: mass阈值调整
================================================================================
问题描述:
- mass阈值1e-2f (0.01)太大，导致很多有效的质量值被跳过
- 原始代码使用1e-2f是为了避免低密度材料的rippling效应

修复内容:
1. 文件: src/algorithms/idd_sigma.cu (第134行)
   - 将mass阈值从1e-2f改为1e-6f
   - 允许更小的质量值参与剂量计算

================================================================================
修复5: 能量索引计算改进
================================================================================
问题描述:
- energyIdx计算需要支持升序和降序排序的energiesPerU数组

修复内容:
1. 文件: src/core/raytracedicom_wrapper.cu (第208-232行)
   - 添加排序方向检测（升序/降序）
   - 根据排序方向使用不同的比较逻辑

================================================================================
测试结果验证
================================================================================
修复前:
- 剂量: 0
- 不同能量层剂量相同（都为0）

修复后:
- Layer 0 (120 MeV): Ray IDD Total = 388.874
- Layer 1 (140 MeV): Ray IDD Total = 12.159  
- Layer 2 (160 MeV): Ray IDD Total = 0.08701
- 最终总剂量: 17.3254
- 最大剂量: 0.0288225
- 非零体素数: 5183/5120000

能量依赖性测试:
- 所有能量层 = 120 MeV: 总剂量 = 45.4247
- 所有能量层 = 140 MeV: 总剂量 = 0.21875
- 所有能量层 = 160 MeV: 总剂量 = 0.000396071

结论: 
✓ 剂量计算正常，且随能量变化
✓ 不同能量产生明显不同的剂量值
✓ 能量越高，剂量越小（符合物理规律，因为高能量质子穿透更深，在浅层沉积的剂量更少）

================================================================================
关键文件修改清单
================================================================================
1. src/core/raytracedicom_wrapper.cu
   - CPB卷积移到循环外
   - rayWeights按层存储
   - volConst/volLin/volSq计算
   - 能量索引计算改进

2. src/algorithms/convolution.cu
   - mapCPBWeightsToRayWeightsKernel添加layerIdx参数
   - performCPBToRayWeightMapping添加layerIdx参数

3. include/algorithms/convolution.h
   - 更新函数声明

4. src/algorithms/idd_sigma.cu
   - mass阈值调整

5. src/tests/wrapper_integration_test.cu
   - energiesPerU数组大小修复
   - CIDD矩阵生成改进

6. src/utils/backward_compatibility.cu
   - 更新函数调用

================================================================================

